Appcelerator.Widget.Datatable={modulePath:null,setPath:function(A){this.modulePath=A},getName:function(){return"appcelerator datatable"},getDescription:function(){return"datatable widget"},getVersion:function(){return"__VERSION__"},getSpecVersion:function(){return 1},getAuthor:function(){return"Amro Mousa"},getModuleURL:function(){return"http://www.appcelerator.org"},isWidget:function(){return true},getWidgetName:function(){return"app:datatable"},getActions:function(){return["execute","stop","start"]},getAttributes:function(){var A=Appcelerator.Types;return[{name:"on",optional:true,description:"Used to populate the data table.",type:A.onExpr},{name:"sort",optional:true,defaultValue:"client",description:"Where the responsibility for sorting items in the table restsValid values are 'client', 'server', and 'off.'",type:A.enumeration("client","server","off")},{name:"sortRequest",optional:true,defaultValue:"",description:"Message to be sent when the sort mode is 'server' and a column header is clicked.",type:A.messageSend},{name:"rowEvenClass",optional:true,defaultValue:"",type:A.cssClass},{name:"rowOddClass",optional:true,defaultValue:"",type:A.cssClass},{name:"width",optional:true,defaultValue:"100%",description:"Width of entire table.",type:A.cssDimension},{name:"property",optional:true,defaultValue:"",type:A.identifier},{name:"pagination",optional:true,defaultValue:"false",type:A.bool},{name:"compile",optional:true,defaultValue:"false",type:A.bool},{name:"module",optional:true,defaultValue:"",type:A.identifier},{name:"maxRows",optional:true,defaultValue:0,type:A.naturalNumber},{name:"sortIndex",optional:true,defaultValue:-1,type:A.naturalNumber},{name:"stickySort",optional:true,defaultValue:true,type:A.bool}]},formatShift1k:function(B,A,C){if(!isNaN(B)){return parseInt(parseInt(B)/1000)}else{return B}},formatShift1000k:function(B,A,C){if(!isNaN(B)){return parseInt(parseInt(B)/1000000)}else{return B}},createDataTable:function(id,pagination_direction){var on_array=[];var element=$(id);var parameterMap=element.parameterMap;var needRecompile=parameterMap.compile;var scope=parameterMap.scope;var sort=parameterMap.sort;var rowEvenClass=parameterMap.rowEvenClass;var rowOddClass=parameterMap.rowOddClass;var width=parameterMap.width;var add_spacers_to_header=parameterMap.add_spacers_to_header;var header_array=parameterMap.header_array;var array=parameterMap.array;var pagination=parameterMap.pagination;var maxRows=parseInt(parameterMap.maxRows);if(pagination=="true"&&!pagination_direction){pagination_direction="forward";maxRows=maxRows==0?10:maxRows}if(pagination=="false"){maxRows=array.length}parameterMap.maxRows=maxRows;var html="";var table_open='<table cellspacing="0" border="0" width="'+width+'">';var table_close="</table>";var table_header_content="";var table_data_content="";var arrow_up_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_up.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';var arrow_down_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_down.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';var spacer_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_spacer.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';if(add_spacers_to_header){for(var i=0,len=header_array.length;i<len;i++){header_array[i]["cell"]=header_array[i]["cell"].replace(arrow_up_img,"");header_array[i]["cell"]=header_array[i]["cell"].replace(arrow_down_img,"");header_array[i]["cell"]=header_array[i]["cell"].replace(spacer_img,"");header_array[i]["cell"]+=spacer_img}}for(var x=0,len=header_array.length;x<len;x++){var header_info=header_array[x];var formatterFunction=eval(header_array[x]["formatter"]);var onheader=header_array[x]["cellon"];var onTemplate=null;if(onheader){needRecompile=true;header_info.onTemplate=new Template('on="'+onheader+'"')}if(formatterFunction){header_info.formatterFunction=formatterFunction}var hclass=header_info["class"];if(hclass==""||hclass==null){hclass="table_cell_header"}var style=header_info.style;if(style!=""&&style!=null){style=' style="'+style+'"'}var or="";if(header_info.on!=""){or=" or "}var sort_string="";if(header_info.sort=="false"){sort_string=""}else{if(sort=="client"){sort_string="click then script[Appcelerator.Widget.Datatable.sortDataTableClient("+x+",'"+id+"')]"}else{if(sort=="server"){sort_string="click then script[Appcelerator.Widget.Datatable.sortDataTableServer("+x+",'"+id+"')]";if(parameterMap.current_server_sort_column==header_info.property){if(!parameterMap.sortBy[parameterMap.current_server_sort_column]){header_info.cell=header_info.cell.replace(spacer_img,"");header_info.cell+=arrow_up_img}else{header_info.cell=header_info.cell.replace(spacer_img,"");header_info.cell+=arrow_down_img}}}else{sort_string=""}}}var hw=header_info.width;var td='<td id="'+id+"_header_"+x+'"'+style+' align="'+header_info.align+'" '+(hw?'width="'+hw+'"':"")+' class="'+hclass+'"><span>'+header_info.cell+"</span></td>";if(sort_string!=""){var header_on_expression=header_info.on+or+sort_string;on_array.push({id:id+"_header_"+x,on:header_on_expression})}table_header_content+=td}table_header_content='<tr class="table_row_header">'+table_header_content+"</tr>";var x=0;var length=maxRows;if(pagination=="true"){if(pagination_direction=="forward"){if($(id).initialLoad){x=$(id).position;$(id).initialLoad=false}else{x=$(id).position+maxRows>=array.length?$(id).position:$(id).position+maxRows}length=x+maxRows>array.length?array.length:x+maxRows}else{if($(id).position-maxRows<0){x=0;length=maxRows>array.length?array.length:maxRows}else{x=$(id).position-maxRows;length=x+maxRows>array.length?array.length:x+maxRows}}$(id).position=x}var xrun=x;for(;xrun<length;xrun++){table_data_content+='<tr class="table_row">';for(var h=0,lenH=header_array.length;h<lenH;h++){var cell_class=(xrun%2==0)?rowEvenClass:rowOddClass;if(cell_class==""){cell_class="table_cell"}var column_property_name=header_array[h]["property"];var formatterFunction=header_array[h]["formatterFunction"];var onTemplate=header_array[h]["onTemplate"];cell_on="";if(onTemplate){cell_on=onTemplate.evaluate(array[xrun])}var cell_value=(Object.getNestedProperty(array[xrun],column_property_name)||"");var dynamicproperty=header_array[h]["dynamicproperty"];if(dynamicproperty){needRecompile=true;cell_value=dynamicproperty.evaluate(array[xrun])}else{if(formatterFunction){cell_value=formatterFunction(cell_value,column_property_name,array[xrun],element);cell_value="<span>"+cell_value+"</span>"}else{cell_value.toString().escapeHTML();cell_value="<span>"+cell_value+"</span>"}}var td='<td align="'+header_array[h]["align"]+'" '+cell_on+' class="'+cell_class+'">'+cell_value+"</td>";table_data_content+=td}table_data_content+="</tr>"}html=table_open+table_header_content+table_data_content+table_close;var myidback=id+"_pagination_back";var myidforward=id+"_pagination_forward";if(pagination=="true"){var pag_html="";var myid="'"+id+"'";var forward='"forward"';var backward="'backward'";pag_html='<div style="padding-bottom: 5px;"><a class="pagination_links" id="'+myidback+'"><img style="border: 0;" src="'+Appcelerator.Widget.Datatable.modulePath+'images/resultset_previous.png"/></a>&nbsp;<a class="pagination_links" id="'+myidforward+'"><img style="border: 0;" src="'+Appcelerator.Widget.Datatable.modulePath+'images/resultset_next.png"/></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Showing '+(x+1)+"-"+(length)+" of "+array.length+"</div>";html=pag_html+html}Appcelerator.Compiler.setHTML(id,html);if(needRecompile){Appcelerator.Compiler.dynamicCompile($(id))}if(pagination=="true"){$(myidback).onclick=function(){Appcelerator.Widget.Datatable.createDataTable(id,"backward")}.bind(this);$(myidforward).onclick=function(){Appcelerator.Widget.Datatable.createDataTable(id,"forward")}.bind(this);$(myidback).onmousedown=function(){Appcelerator.Widget.Datatable.paginateContinuously(id,"backward")}.bind(this);$(myidforward).onmousedown=function(){Appcelerator.Widget.Datatable.paginateContinuously(id,"forward")}.bind(this);$(myidback).onmouseup=function(){Appcelerator.Widget.Datatable.stopContinuousPagination(id)}.bind(this);$(myidforward).onmouseup=function(){Appcelerator.Widget.Datatable.stopContinuousPagination(id)}.bind(this);$(myidback).onmouseout=function(){Appcelerator.Widget.Datatable.stopContinuousPagination(id)}.bind(this);$(myidforward).onmouseout=function(){Appcelerator.Widget.Datatable.stopContinuousPagination(id)}.bind(this)}if(length>0){var on_run_array=[];for(var i=0,len=on_array.length;i<len;i++){on_run_array.push(Appcelerator.Compiler.compileExpression($(on_array[i]["id"]),on_array[i]["on"],false))}eval(on_run_array.join(";"))}},compileWidget:function(B,A){},paginateContinuously:function(C,A){var B=function(){if(A=="forward"){Appcelerator.Widget.Datatable.createDataTable(C,"forward")}else{Appcelerator.Widget.Datatable.createDataTable(C,"backward")}};$(C).paginationInterval=setInterval(B,250)},stopContinuousPagination:function(A){clearInterval($(A).paginationInterval)},sortDataTableClient:function(index,id,maintainSortOrder){var parameterMap=$(id).parameterMap;var header_array=parameterMap.header_array;var array=parameterMap.array;var column_property_name=header_array[index]["property"];parameterMap.lastSortIndex=index;$(id).position=0;$(id).initialLoad=true;var sortFunction=eval(header_array[index]["sorter"]);var num_sort=false;if(!sortFunction){num_sort=true;for(var x=0,len=array.length;x<len;x++){var cell_value=(Object.getNestedProperty(array[x],column_property_name)||"");if(isNaN(parseFloat(cell_value))){num_sort=false;break}}}if(parameterMap.sortBy==null){parameterMap.sortBy={};parameterMap.sortBy[column_property_name]=false}parameterMap.sortBy[column_property_name]=!maintainSortOrder?!parameterMap.sortBy[column_property_name]:parameterMap.sortBy[column_property_name];if(sortFunction){var customSort=function(a,b){var aval=Object.getNestedProperty(a,column_property_name);var bval=Object.getNestedProperty(b,column_property_name);return sortFunction(aval,bval)};array.sort(customSort);if(parameterMap.sortBy[column_property_name]==false){array.reverse()}}else{if(num_sort){var compareNum=function compare(a,b){var anum=Object.getNestedProperty(a,column_property_name);var bnum=Object.getNestedProperty(b,column_property_name);if(parameterMap.sortBy[column_property_name]==true){if(isNaN(parseFloat(anum))){return 1}else{return parseFloat(anum)-parseFloat(bnum)}}else{if(isNaN(parseFloat(bnum))){return 1}else{return parseFloat(bnum)-parseFloat(anum)}}};array.sort(compareNum)}else{var compareString=function compare(a,b){var astr=Object.getNestedProperty(a,column_property_name);var bstr=Object.getNestedProperty(b,column_property_name);if(bstr){bstr=bstr.toString().toLowerCase()}if(astr){astr=astr.toString().toLowerCase()}return(parameterMap.sortBy[column_property_name]==true)?(bstr<astr)-(astr<bstr):(astr<bstr)-(bstr<astr)};array.sort(compareString)}}var arrow_up_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_up.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';var arrow_down_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_down.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';var spacer_img='<img src="'+Appcelerator.Widget.Datatable.modulePath+'images/arrow_spacer.png" title="sort ascending" style="position:relative;top:-1px; left: 2px;" />';for(var i=0,len=header_array.length;i<len;i++){header_array[i]["cell"]=header_array[i]["cell"].replace(arrow_up_img,"");header_array[i]["cell"]=header_array[i]["cell"].replace(arrow_down_img,"");header_array[i]["cell"]=header_array[i]["cell"].replace(spacer_img,"");header_array[i]["cell"]+=spacer_img}if(!parameterMap.sortBy[column_property_name]){header_array[index]["cell"]=header_array[index]["cell"].replace(spacer_img,"");header_array[index]["cell"]+=arrow_up_img}else{header_array[index]["cell"]=header_array[index]["cell"].replace(spacer_img,"");header_array[index]["cell"]+=arrow_down_img}parameterMap.add_spacers_to_header=false;Appcelerator.Widget.Datatable.createDataTable(id)},sortNan:function(B,A){if(!B){B=0}if(!A){A=0}if(!isNaN(B)||"NaN"==B&&!isNaN(A)||"NaN"==A){if(B=="NaN"){return -1}else{if(A=="NaN"){return 1}else{return parseFloat(B)-parseFloat(A)}}}else{return(A<B)-(B<A)}},sortDataTableServer:function(C,G){var A=$(G).parameterMap;var E=A.header_array;var F=A.array;var B=E[C]["property"];if(A.sortBy==null){A.sortBy={};A.sortBy[B]=false}A.sortBy[B]=!A.sortBy[B];A.current_server_sort_column=B;var D="";if(A.sortBy[B]){D="desc"}else{D="asc"}$MQ(A.sortRequest,{property:B,direction:D},A.scope)},stop:function(E,C,D,B,A){$(E).stopped=true},start:function(E,C,D,B,A){$(E).stopped=false},execute:function(C,A,F,I){if($(C).stopped){$D("not executing datatable for "+C);return }$D("excuting datatable for "+C);var D=$(C).parameterMap||A;var G=A.property;var E=A.stickySort||true;var B=D.lastSortIndex;var H;$(C).position=0;$(C).initialLoad=true;if(G){H=Object.getNestedProperty(F,G)||[]}if(!Object.isArray(H)){H=[H]}A.array=H;A.scope=I;$(C).parameterMap=A;if(E=="false"){E=false}if(E=="true"){E=true}if(E&&(typeof B!="undefined"&&B!=-1)){Appcelerator.Widget.Datatable.sortDataTableClient(B,C,true)}else{Appcelerator.Widget.Datatable.createDataTable(C)}},buildWidget:function(E,I){var H=document.createElement("div");H.innerHTML=E.innerHTML.replace(/<HEADER/gi,"<div").replace(/<\/HEADER/gi,"</div");var C=H.childNodes;var D=[];for(var F=0,G=C.length;F<G;F++){if(C[F].nodeName.toLowerCase()=="div"){var B={};if(C[F].getAttribute("langid")){B.cell=Appcelerator.Localization.get(C[F].getAttribute("langid"));var A=Appcelerator.Compiler.getHtml(C[F],true);if(A){B.dynamicproperty=new Template(A)}}else{if(C[F].getAttribute("title")){B.cell=C[F].getAttribute("title");var A=Appcelerator.Compiler.getHtml(C[F],true);if(A){B.dynamicproperty=new Template(A)}}else{B.cell=Appcelerator.Compiler.getHtml(C[F],true)}}B.on=C[F].getAttribute("on")||"";B.cellon=C[F].getAttribute("cellon")||"";B["class"]=C[F].className||"";B.style=C[F].getAttribute("style")||"";B.property=C[F].getAttribute("property")||"";B.align=C[F].getAttribute("align")||"";B.sorter=C[F].getAttribute("sorter")||"";B.sort=C[F].getAttribute("sort")||C[F].getAttribute("sortable")||"true";B.formatter=C[F].getAttribute("formatter")||"";D.push(B)}}I.header_array=D;I.add_spacers_to_header=true;return{presentation:"",position:Appcelerator.Compiler.POSITION_REPLACE,compile:true,parameters:I}}};Appcelerator.Core.loadModuleCSS("app:datatable","datatable.css");Appcelerator.Widget.register("app:datatable",Appcelerator.Widget.Datatable);