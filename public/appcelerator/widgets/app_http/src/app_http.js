Appcelerator.Widget.Http={getName:function(){return"appcelerator http"},getDescription:function(){return"http widget"},getVersion:function(){return"__VERSION__"},getSpecVersion:function(){return 1},getAuthor:function(){return"Hamed Hashemi"},getModuleURL:function(){return"http://www.appcelerator.org"},isWidget:function(){return true},getWidgetName:function(){return"app:http"},getAttributes:function(){var A=Appcelerator.Types;return[{name:"on",optional:false,type:A.onExpr,description:"Used to execute requests"},{name:"response",optional:true,type:A.messageSend,description:"Message to fire when successful. Will contain JSONified payload"},{name:"error",optional:true,type:A.messageSend,description:"Message to fire when errors are received from server"}]},getChildNodes:function(){var A=Appcelerator.Types;return[{name:"uri",attributes:[{name:"method",optional:false,type:A.enumeration("get","post","put","delete")},{name:"uri",optional:false,type:A.pathOrUrl,description:"Where to send the HTTP request, may contain template variables pulled from the triggering message"},{name:"response",optional:true,type:A.messageSend,description:"Message to fire when successful. Will contain JSONified payload"},{name:"error",optional:true,type:A.messageSend,description:"Message to fire when errors are received from server"},{name:"property",optional:false,type:A.identifier,description:""},{name:"responseRegex",optional:true,type:A.regex,description:"Regular expression used to capture a section of text from the HTTP Response. The first group of the match will be used."},{name:"contentType",optional:true,defaultValue:"application/x-www-form-urlencoded",type:A.openEnumeration("application/x-www-form-urlencoded","text/plain","text/xml","text/json","text/javascript")}]}]},getActions:function(){return["post","get","options","put","delete"]},options:function(E,D,C,B,A){Appcelerator.Widget.Http.performFetch(D,C,"options")},put:function(E,D,C,B,A){Appcelerator.Widget.Http.performFetch(D,C,"put")},"delete":function(E,D,C,B,A){Appcelerator.Widget.Http.performFetch(D,C,"delete")},post:function(E,D,C,B,A){Appcelerator.Widget.Http.performFetch(D,C,"post")},get:function(E,D,C,B,A){Appcelerator.Widget.Http.performFetch(D,C,"get")},performFetch:function(params,data,method){var uri=params.uri[method];if(!uri){$E("no method mapped for "+method);return }var response=uri.response||params.response;var error=uri.error||params.error;var property=uri.property;var responseRegex=uri.responseRegex;var contentType=uri.contentType||"application/x-www-form-urlencoded";var array=null;if(property){array=Object.getNestedProperty(data,property)||[]}else{array=Object.toJSON(data).evalJSON()}var methodParams=array;var body=uri.body;if(body!=""){var bodycompiled=eval(Appcelerator.Compiler.compileTemplate(body,true,"body_init_"+params.id)+"; body_init_"+params.id);body=bodycompiled(array).trim();if(!uri.contentType){contentType="text/plain;charset=UTF-8"}methodParams=null}var compiled=eval(uri.uri+"; init_"+params.id);var uriLink=compiled(array).trim();if(uriLink.startsWith("http://")){var uriStrip=uriLink.match("http://[^/]*");var currentStrip=window.location.href.match("http://[^/]*");$D("uriStrip="+uriStrip+", currentStrip="+currentStrip+", uriLink="+uriLink+", current location="+window.location.href);if(currentStrip&&uriStrip&&(uriStrip[0].toLowerCase()!=currentStrip[0].toLowerCase())){var proxy=Appcelerator.ServerConfig.proxy;if(proxy){if(methodParams&&method!="post"&&method!="put"){if(uriLink.indexOf("?")<0){uriLink+="?"}else{uriLink+="&"}for(var k in methodParams){uriLink+=k+"="+methodParams[k]+"&"}}uriLink=proxy.value+"?url="+encodeURIComponent(encodeURI(uriLink));methodParams=null}}}$D("app:http sending request to "+uriLink+" with params "+methodParams);new Ajax.Request(uriLink,{method:method,parameters:methodParams,evalJSON:false,evalJS:false,postBody:body,contentType:contentType,onSuccess:function(result){contentType=result.getResponseHeader("Content-Type");$D("app:http onSuccess doing "+method+" to "+uriLink+", status = "+result.status+", contentType = "+contentType+", text = "+result.responseText);if(response){var json_result={};if(contentType.indexOf("/xml")>0){json_encode_xml(result.responseXML.documentElement,json_result)}else{if(contentType.indexOf("/json")>0||contentType.indexOf("/plain")>0||contentType.indexOf("/javascript")>0){var text=result.responseText.trim();if(responseRegex){var re=new RegExp(responseRegex);var match=re.exec(text);if(match&&match.length>1){text=match[1]}}json_result=text.evalJSON()}else{json_result.contentType=contentType;json_result.responseText=result.responseText}}(function(){$MQ(response,json_result)}).defer()}},onException:function(resp,ex){var msg=new String(ex);$E("app:http onException doing "+method+" to "+uriLink+", exception was: "+msg);if(error){$MQ(error,{msg:msg,uri:uriLink})}},onFailure:function(result,json){$E("app:http onFailure doing "+method+" to "+uriLink+", status = "+result.status+", text = "+result.statusText);if(error){$MQ(error,{msg:result.statusText,uri:uriLink})}}})},buildWidget:function(B,D){var A={};if(Appcelerator.Browser.isIE){var C=B.innerHTML;C=C.replace(/<URI/g,"<APP:URI").replace(/\/URI>/g,"/APP:URI>");B.innerHTML=C}for(var E=0;E<B.childNodes.length;E++){(function(){var G=B.childNodes[E];if(G.nodeType==1&&G.nodeName=="URI"){uriLink=Appcelerator.Compiler.compileTemplate(G.getAttribute("uri"),true,"init_"+B.id);var F={uri:uriLink,response:G.getAttribute("response"),args:G.getAttribute("args"),property:G.getAttribute("property"),error:G.getAttribute("error"),responseRegex:G.getAttribute("responseRegex"),body:G.innerHTML};A[G.getAttribute("method")]=F}})()}D.uri=A;return{presentation:"",position:Appcelerator.Compiler.POSITION_REPLACE}}};Appcelerator.Widget.register("app:http",Appcelerator.Widget.Http);